!function(t){var e={};function i(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(a,n,function(e){return t[e]}.bind(null,n));return a},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=10)}([function(t,e){var i=function(t,e){this.id=t,this.name="player"+t.substring(0,6),this.socket=e};i.prototype={getId:function(){return this.id},getName:function(){return this.name},setName:function(t){this.name=t},getSocket:function(){return this.socket},getDTO:function(){return{id:this.getId(),name:this.getName()}}},t.exports=i},function(t){t.exports={gameConfiguration:[{nbplayer:3,gap:5,given:[3,3,3,3,3,3,2],filtering:!1},{nbplayer:4,gap:5,given:[3,3,3,3,3],filtering:!1},{nbplayer:5,gap:4,given:[3,3,3,3],filtering:!1},{nbplayer:6,gap:3,given:[3,3,3,1],filtering:!1},{nbplayer:7,gap:3,given:[3,3,2],filtering:!0},{nbplayer:8,gap:3,given:[3,3,1],filtering:!0}]}},function(t,e){var i=function(t,e,i,a,n,r,s){this.scoringGame=[],this.playedCards=[],this.givenCards=i,this.action=a,this.gap=n,this.ppyou=r,this.currentPlayer=s,t.forEach(function(t){this.scoringGame.push(t)}),e.forEach(function(t,e){this.playedCards.push({id:e,card:t})},this)};i.prototype={},t.exports=i},function(t,e){var i=function(t,e,i,a){this.id=t,this.rank=e,this.suit=i,this.value=a||0,this.selected=!1};i.prototype={},t.exports=i},function(t,e,i){var a=i(3),n=i(2),r=i(1),s=[1,2,3,4,5,6,7,8,9,10],o=["S","H","C","D"],d=function(t,e){this.id=t,this.players=e,this.deck=[],this.gameConfig,this.playerReady=0,this.ScoringGame=new Map,this.playedCards=[],this.givenCards=new Map,this.gapCards=new Map,this.winningCard=new Map,this.startingPlayPlayer,this.currentTurnPlayer,this.firstCard=null,this.ppyou};d.prototype={start:function(){that=this,this.startingPlayPlayer=0,this.currentTurnPlayer=0,this.initiateGameScoring(),this.loadGameConfiguratiton(this.players.length),this.initiateDeck(),this.randomizeDeck(),this.distributeGiven(this.players.length),this.startGame()},loadGameConfiguratiton:function(t){this.gameConfig=r.gameConfiguration.find(function(e){return e.nbplayer===t})},startGame:function(){this.players.forEach(function(t){t.socket.addListener("ready to play",function(){logger.debug("EVENT : ready to play"),that.playerReady++,that.playerReady==that.players.length&&(that.refreshData("GAP"),that.playerReady=0)}),t.socket.addListener("gap",function(t){logger.debug("EVENT : gap"),that.isValidGap(this.id,t)&&(that.playerReady++,that.gapCards.set(this.id,t)),that.playerReady==that.players.length&&(that.dispatchGap(),that.refreshData("NONE"),setTimeout(function(){that.clearHand(),that.refreshData("PLAY")},3e3),that.playerReady=0)}),t.socket.addListener("play card",function(t){if(logger.debug("EVENT : play card"),that.isValidPlayedCard(this.id,t)){var e=that.givenCards.get(this.id).filter(function(e){return e.id===t})[0];null===that.firstCard&&(that.firstCard=e),that.playedCards[that.playedCards.length-1].set(this.id,e),that.givenCards.set(this.id,that.givenCards.get(this.id).filter(function(t){return t.id!=e.id})),that.refreshData("NONE"),that.playedCards.length===that.gameConfig.given.reduce(function(t,e){return t+e},0)&&that.playedCards[that.playedCards.length-1].size===that.players.length?setTimeout(function(){var t=that.defineWinner(that.playedCards[that.playedCards.length-1]);that.playedCards[that.playedCards.length-1].forEach(function(e){that.winningCard.get(t).push(e)}),that.players.forEach(function(t){that.updateScoringGame(t.id,that.winningCard.get(t.id).map(function(t){return t.value}).reduce(function(t,e){return t+e},0))}),that.startingPlayPlayer=(that.startingPlayPlayer+1)%that.players.length,that.playedCards=[],that.playedCards.push(new Map),that.firstCard=null,that.players.forEach(function(t){that.winningCard.set(t.id,[])}),that.initiateDeck(),that.randomizeDeck(),that.distributeGiven(that.players.length),that.refreshData("GAP")},3e3):that.playedCards[that.playedCards.length-1].size===that.players.length?setTimeout(function(){var t=that.defineWinner(that.playedCards[that.playedCards.length-1]);that.currentTurnPlayer=that.players.findIndex(function(e){return e.id===t}),that.playedCards[that.playedCards.length-1].forEach(function(e){that.winningCard.get(t).push(e)}),that.playedCards.push(new Map),that.firstCard=null,that.refreshData("PLAY")},3e3):(that.currentTurnPlayer=(that.currentTurnPlayer+1)%that.players.length,that.refreshData("PLAY"))}else that.refreshData("PLAY")})})},defineWinner:function(t){var e=null,i=that.firstCard;return t.forEach(function(t,i){t===that.firstCard&&(e=i)}),t.forEach(function(t,a){t.suit===i.suit&&t.rank>i.rank&&(e=a,i=t)}),e},isValidPlayedCard:function(t,e){var i;i=that.players[that.currentTurnPlayer].id===t;var a=that.givenCards.get(t).filter(function(t){return t.id===e});return i=(i=i&&1===a.length)&&(null===that.firstCard||that.firstCard.suit===a[0].suit||!that.givenCards.get(t).some(function(t){return t.suit===that.firstCard.suit}))},clearHand:function(){that.players.forEach(function(t){that.givenCards.set(t.id,that.givenCards.get(t.id).map(function(t){return t.selected=!1,t}))})},dispatchGap:function(){that.players.forEach(function(t,e){var i=that.givenCards.get(t.id).filter(function(e){return that.gapCards.get(t.id).indexOf(e.id)>=0}).map(function(t){return t.selected=!0,t}),a=that.players[(e+1)%that.players.length],n=that.givenCards.get(a.id).concat(i);n.sort(function(t,e){return t.id-e.id}),that.givenCards.set(a.id,n);var r=that.givenCards.get(t.id).filter(function(e){return that.gapCards.get(t.id).indexOf(e.id)<0});that.givenCards.set(t.id,r)})},isValidGap:function(t,e){return logger.debug("isValidGap"),e.every(function(e){that.givenCards.get(t).map(function(t){return t.id}).indexOf(e)})},refreshData:function(t){logger.debug("refreshData"),that.players.forEach(function(e,i){e.socket.emit("refresh data",new n(that.ScoringGame,that.playedCards[that.playedCards.length-1],that.givenCards.get(e.getId()),"PLAY"===t&&i===that.currentTurnPlayer||"PLAY"!==t?t:"NONE",that.gameConfig.gap,that.ppyou,that.currentTurnPlayer))})},initiateGameScoring:function(){logger.debug("initiateGameScoring"),this.players.forEach(function(t){that.ScoringGame.set(t.id,{id:t.id,name:t.name,score:0}),that.winningCard.set(t.id,[])}),this.playedCards.push(new Map)},updateScoringGame:function(t,e){logger.debug("updateScoringGame");var i=this.ScoringGame.get(t);this.ScoringGame.set(t,{id:i.id,name:i.name,score:i.score+e})},initiateDeck:function(){logger.debug("initiateDeck"),that.ppyou=o[Math.floor(Math.random()*o.length)];var t=0;o.forEach(function(e){s.forEach(function(i){if(!that.gameConfig.filtering||"1"!==i){var n=new a(t++,i,e,7===i&&e===that.ppyou?40:0);this.deck.push(n)}})});for(var e=1;e<21;e++){var i=new a(t++,e,"B",e);this.deck.push(i)}},randomizeDeck:function(){this.deck.sort(function(){return.5-Math.random()})},distributeGiven:function(){this.gameConfig.given.forEach(function(t){this.players.forEach(function(e){var i=this.givenCards.get(e.id);void 0===i&&(i=[]),(i=i.concat(this.deck.slice(0,t))).sort(function(t,e){return t.id-e.id}),this.givenCards.set(e.id,i),this.deck=this.deck.slice(t,this.deck.length)})})}},t.exports=d},function(t,e,i){var a=i(4),n=function(t){this.id=t,this.players=[],this.status="WAITING"};n.prototype={getId:function(){return this.id},getPlayers:function(){return this.players},addPlayer:function(t){this.playerById(t.getId())||this.players.push(t)},removePlayer:function(t){var e=this.playerById(t);e&&this.players.splice(this.players.indexOf(e),1)},playerById:function(t){for(var e=0;e<this.players.length;e++)if(this.players[e].getId()==t)return this.players[e];return!1},getStatus:function(){return this.status},start:function(){this.status="INPROGRESS",this.gameEngine=new a(this.id,this.players),this.gameEngine.start()}},t.exports=n},function(t,e){t.exports=require("winston")},function(t,e){t.exports=require("socket.io")},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("express")},function(t,e,i){(function(t){var e=i(9),a=e(),n=i(8).Server(a),r=i(7)(n,{serveClient:!1}),s=i(6),o=s.config;logger=new s.Logger({level:"debug",transports:[new s.transports.Console({timestamp:function(){return Date.now()},formatter:function(t){return new Intl.DateTimeFormat("fr-FR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour24:!0}).format(t.timestamp())+" "+o.colorize(t.level,t.level.toUpperCase())+" "+(t.message?t.message:"")+(t.meta&&Object.keys(t.meta).length?"\n\t"+JSON.stringify(t.meta):"")}})]}),r.set("transports",["polling","websocket"]);var d=i(5),h=i(0),u=[],g=[],l=[];a.use(e.static("client"));var c=process.env.PORT||process.env.OPENSHIFT_NODEJS_PORT||8080;process.env.IP||process.env.OPENSHIFT_NODEJS_IP;function f(t){logger.debug("onRename"),p(this.id).setName(t)}n.listen(c,null,function(){logger.debug("Listening on "+this._connectionKey)}),a.get("/",function(e,i){i.sendFile(t+"/client/index.html")}),logger.debug("Starting Server"),r.on("connection",function(t){logger.debug("New player has connected: "+t.id);var e=new h(t.id,t);g.push(e),t.on("disconnect",v),t.on("rename",f),t.on("get gamelist",b),t.on("host game",G),t.on("join game",S),t.on("get playerlist",y),t.on("leave game",m),t.on("start game",E)}),logger.debug("Server Initialized");var p=function(t){for(var e=0;e<g.length;e++)if(g[e].id==t)return g[e];return!1};function y(t){logger.debug("onPlayerList");var e=C(t.id);e?this.emit("list players",e.getPlayers().map(function(t){return t.getDTO()})):logger.debug("Game not found: "+t.id)}function m(t){logger.debug("onLeaveGame");var e=C(t.id);e?(this.id===t.id?(this.to(t.id).broadcast.emit("end game",e.id),u.splice(u.indexOf(e),1),this.broadcast.emit("list games",u.filter(P).slice(0,4).map(function(t){return{id:t.getId()}}))):(e.removePlayer(this.id),this.to(t.id).broadcast.emit("list players",e.getPlayers().map(function(t){return t.getDTO()}))),this.leave(t.id)):logger.debug("Game not found: "+this.id)}function v(){logger.debug("onClientDisconnect"),logger.debug("Player disconnected: "+this.id);var t=l[this.id],e=C(t);e?(l[this.id]=null,t===this.id||"INPROGRESS"===e.getStatus()?(this.to(t).broadcast.emit("end game",e.id),u.splice(u.indexOf(e),1),this.broadcast.emit("list games",u.filter(P).slice(0,4).map(function(t){return{id:t.getId()}}))):"WAITING"===e.getStatus()&&(e.removePlayer(this.id),this.to(t).broadcast.emit("list players",e.getPlayers().map(function(t){return t.getDTO()})))):logger.debug("Game not found: "+t)}var C=function(t){for(var e=0;e<u.length;e++)if(u[e].id==t)return u[e];return!1};function b(){logger.debug("onGameList"),this.emit("list games",u.filter(P).slice(0,4).map(function(t){return{id:t.getId()}}))}function P(t){return"WAITING"==t.status}function G(t){if(logger.debug("onHostGame"),function(t){for(var e=0;e<u.length;e++)if(u[e].id===t)return!0;return!1}(this.id))logger.debug("game already host : "+this.id);else{logger.debug("host new game : "+this.id);var e=new d(this.id),i=p(this.id);i.setName(t.name),e.addPlayer(i),l[this.id]=this.id,u.push(e),this.join(this.id),this.emit("game joined",{id:e.getId()}),this.broadcast.emit("list games",u.map(function(t){return{id:t.getId()}}))}}function S(t){logger.debug("onJoinGame : "+t.id);var e=C(t.id);if(e){this.join(t.id);var i=p(this.id);i.setName(t.name),e.addPlayer(i),l[this.id]=t.id,this.to(t.id).broadcast.emit("list players",e.getPlayers().map(function(t){return t.getDTO()})),this.emit("game joined",{id:e.getId()})}else logger.debug("Game not found: "+t.id)}function E(){logger.debug("onStartGame");var t=l[this.id];C(t).start(),this.to(t).broadcast.emit("start game")}}).call(this,"/")}]);